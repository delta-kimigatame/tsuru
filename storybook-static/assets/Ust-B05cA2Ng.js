var c=Object.defineProperty;var l=(o,s,t)=>s in o?c(o,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[s]=t;var n=(o,s,t)=>l(o,typeof s!="symbol"?s+"":s,t);import{r as h}from"./readTextFile-BNLodD0O.js";import{N as f}from"./Note-CcnmOUAw.js";class d{constructor(){n(this,"_tempo");n(this,"flags");n(this,"notes");this._tempo=120}get tempo(){return this._tempo}set tempo(s){this._tempo=Math.max(Math.min(s,512),10)}async load(s){let t;return new Promise(async a=>{const e=await h(s);e.includes("Charset=UTF-8")&&(t=await h(s,"UTF8"));const i=(t===void 0?e:t).replace(/\r/g,"").split(`
`),r=i.indexOf("[#0000]");this.loadHeader(i.slice(0,r)),this.loadNote(i.slice(r));for(let p=1;p<this.notes.length;p++)this.notes[p-1].next=this.notes[p],this.notes[p].prev=this.notes[p-1];a()})}loadHeader(s){for(let t=0;t<s.length;t++)s[t].startsWith("Tempo=")?this.tempo=parseFloat(s[t].replace("Tempo=","")):s[t].startsWith("Flags=")&&(this.flags=s[t].replace("Flags=",""))}loadNote(s){this.notes=new Array;let t,a=this.tempo;s.forEach(e=>{if(e!=="[#TRACKEND]")if(e.startsWith("[#"))t=new f,t.index=parseInt(e.slice(2,-1)),t.tempo=a,this.notes.push(t);else if(e.startsWith("Length="))t.length=parseInt(e.replace("Length=",""));else if(e.startsWith("Lyric="))t.lyric=e.replace("Lyric=","");else if(e.startsWith("NoteNum="))t.notenum=parseInt(e.replace("NoteNum=",""));else if(e.startsWith("Tempo="))t.tempo=parseFloat(e.replace("Tempo=","")),a=t.tempo,t.hasTempo=!0;else if(e.startsWith("PreUtterance=")){const i=parseFloat(e.replace("PreUtterance=",""));isNaN(i)||(t.preutter=i)}else e.startsWith("VoiceOverlap=")?t.overlap=parseFloat(e.replace("VoiceOverlap=","")):e.startsWith("StartPoint=")?t.stp=parseFloat(e.replace("StartPoint=","")):e.startsWith("Velocity=")?t.velocity=parseInt(e.replace("Velocity=","")):e.startsWith("Intensity=")?t.intensity=parseInt(e.replace("Intensity=","")):e.startsWith("Modulation=")?t.modulation=parseInt(e.replace("Modulation=","")):e.startsWith("PitchBend=")?t.pitches=e.replace("PitchBend=",""):e.startsWith("PBStart=")?t.pbStart=parseFloat(e.replace("PBStart=","")):e.startsWith("PBS=")?t.pbs=e.replace("PBS=",""):e.startsWith("PBY=")?t.pby=e.replace("PBY=",""):e.startsWith("PBM=")?t.pbm=e.replace("PBM=",""):e.startsWith("PBW=")?t.pbw=e.replace("PBW=",""):e.startsWith("Flags=")?t.flags=e.replace("Flags=",""):e.startsWith("VBR=")?t.vibrato=e.replace("VBR=",""):e.startsWith("Envelope=")?t.envelope=e.replace("Envelope=",""):e.startsWith("Label=")?t.label=e.replace("Label=",""):e.startsWith("$direct=")?t.direct=e.replace("$direct=","").toLowerCase()==="true":e.startsWith("$region=")?t.region=e.replace("$region=",""):e.startsWith("$region_end=")&&(t.regionEnd=e.replace("$region_end=",""))})}getRequestParam(s,t,a){return this.notes.forEach(r=>r.applyOto(s)),(a&&a.length>0?a.map(r=>this.notes[r]):this.notes).map(r=>r.getRequestParam(s,this.flags,t))}}export{d as U};
