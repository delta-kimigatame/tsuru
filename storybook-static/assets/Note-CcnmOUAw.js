var f=Object.defineProperty;var M=(l,t,e)=>t in l?f(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var h=(l,t,e)=>M(l,typeof t!="symbol"?t+"":t,e);import{m as y}from"./interp-BFp6dTGs.js";import{t as P,n as x}from"./Notenum-DIq-GRnt.js";P("A4");const g=l=>l<26?String.fromCharCode(l+65):l<52?String.fromCharCode(l+97-26):l<62?String.fromCharCode(l+48-52):l===62?"+":"/",w=l=>{const t=[];return l.forEach(e=>{const s=e<0?e+4096:e;t.push(g(Math.floor(s/64))+g(s%64))}),t},O=l=>{let t="",e="",s=0;return l.forEach(i=>{e!==i?(e=i,s!==0&&(t+=`#${s}#`),s=0,t+=i):s++}),s!==0&&(t+=`#${s}#`),t},I=l=>O(w(l));class b{constructor(){h(this,"index");h(this,"_length");h(this,"_lyric");h(this,"_oto");h(this,"_notenum");h(this,"_tempo");h(this,"hasTempo");h(this,"_preutter");h(this,"_overlap");h(this,"otoPreutter");h(this,"otoOverlap");h(this,"_stp");h(this,"_atPreutter");h(this,"_atOverlap");h(this,"_atStp");h(this,"_atAlias");h(this,"_atFilename");h(this,"_velocity");h(this,"_intensity");h(this,"_modulation");h(this,"_pitches");h(this,"pbStart");h(this,"_pbs");h(this,"_pby");h(this,"_pbw");h(this,"_pbm");h(this,"_envelope");h(this,"_vibrato");h(this,"label");h(this,"direct");h(this,"region");h(this,"regionEnd");h(this,"flags");h(this,"voiceColor");h(this,"prev");h(this,"next")}get length(){return this._length}set length(t){this._length=Math.max(Math.floor(t),0)}get lyric(){return this._lyric}set lyric(t){this._lyric=t,this._oto=void 0,this.next!==void 0&&this.tempo!==void 0&&this.length!==void 0&&this.next.autoFitParam()}get notenum(){return this._notenum}set notenum(t){this._notenum=Math.max(Math.min(Math.floor(t),107),24)}get tempo(){return this._tempo}set tempo(t){this._tempo=Math.max(Math.min(t,512),10)}get preutter(){return this._preutter}set preutter(t){this._preutter=Math.max(t,0),this.autoFitParam()}get overlap(){return this._overlap}set overlap(t){this._overlap=t,this.autoFitParam()}get stp(){return this._stp}set stp(t){this._stp=Math.max(t,0),this.autoFitParam()}get atPreutter(){return this._atPreutter}get atOverlap(){return this._atOverlap}get atStp(){return this._atStp}get atAlias(){return this._atAlias}get atFilename(){return this._atFilename}get velocity(){return this._velocity}set velocity(t){this._velocity=Math.max(Math.min(Math.floor(t),200),0),this.autoFitParam()}get intensity(){return this._intensity}set intensity(t){this._intensity=Math.max(Math.min(Math.floor(t),200),0)}get modulation(){return this._modulation}set modulation(t){this._modulation=Math.max(Math.min(Math.floor(t),200),-200)}get pitches(){return this._pitches}set pitches(t){this._pitches=t.split(",").map(e=>Math.max(Math.min(parseInt(e),2047),-2048))}setPitches(t){this._pitches=t.map(e=>Math.max(Math.min(Math.floor(e),2047),-2048))}get pbs(){return this._pbs}set pbs(t){if(t.replace(",",";").includes(";")){const[s,i]=t.replace(",",";").split(";");this._pbs={time:parseFloat(s),height:Math.min(Math.max(parseFloat(i),-200),200)}}else this._pbs={time:parseFloat(t),height:0}}set pbsTime(t){this.pbs===void 0?this._pbs={time:t,height:0}:this._pbs.time=t}set pbsHeight(t){this.pbs===void 0?this._pbs={time:0,height:Math.min(Math.max(t,-200),200)}:this._pbs.height=Math.min(Math.max(t,-200),200)}get pby(){return this._pby}set pby(t){this._pby=t.split(",").map(e=>Math.min(Math.max(parseFloat(e),-200),200))}setPby(t){this._pby=t.map(e=>Math.min(Math.max(e,-200),200))}get pbw(){return this._pbw}set pbw(t){this._pbw=t.split(",").map(e=>Math.max(parseFloat(e),0))}setPbw(t){this._pbw=t.map(e=>Math.max(e,0))}get pbm(){return this._pbm}set pbm(t){this._pbm=t.split(",").map(e=>["","s","r","j"].includes(e)?e:"")}setPbm(t){this._pbm=t}get envelope(){return this._envelope}set envelope(t){const e=t.split(","),s=new Array,i=new Array;e.forEach((o,r)=>{[0,1,2,8,9].includes(r)?s.push(Math.max(parseFloat(o),0)):[3,4,5,6,10].includes(r)&&i.push(Math.min(Math.max(parseInt(o),0),200))}),this._envelope={point:s,value:i}}setEnvelope(t){if(t===void 0){this._envelope=void 0;return}this._envelope={point:t.point.map(e=>Math.max(e,0)),value:t.value.map(e=>Math.min(Math.max(e,0),200))}}get vibrato(){return this._vibrato}set vibrato(t){if(t===void 0){this._vibrato=void 0;return}const[e,s,i,o,r,n,p]=t.split(",").map(a=>parseFloat(a));this._vibrato={length:Math.min(Math.max(e,0),100),cycle:Math.min(Math.max(s,64),512),depth:Math.min(Math.max(i,5),200),fadeInTime:Math.min(Math.max(o,0),100),fadeOutTime:Math.min(Math.max(r,0),100),phase:Math.min(Math.max(n,-100),100),height:Math.min(Math.max(p,-100),100)}}set vibratoLength(t){this._vibrato.length=Math.min(Math.max(t,0),100)}set vibratoCycle(t){this.vibrato.cycle=Math.min(Math.max(t,64),512)}set vibratoDepth(t){this.vibrato.depth=Math.min(Math.max(t,5),200)}set vibratoFadeInTime(t){this._vibrato.fadeInTime=Math.min(Math.max(t,0),100)}set vibratoFadeOutTime(t){this._vibrato.fadeOutTime=Math.min(Math.max(t,0),100)}set vibratoPhase(t){this._vibrato.phase=Math.min(Math.max(t,-100),100)}set vibratoHeight(t){this._vibrato.height=Math.min(Math.max(t,-100),100)}get msLength(){if(this._length===void 0)throw new Error("length is not initial.");if(this._tempo===void 0)throw new Error("tempo is not initial.");return 60/this._tempo*this._length/480*1e3}get velocityRate(){return this._velocity===void 0?1:2**((100-this._velocity)/100)}applyOto(t){if(this._lyric===void 0)throw new Error("lyric is not initial.");if(this._notenum===void 0)throw new Error("notenum is not initial.");const e=t.getOtoRecord(this._lyric,this.notenum,this.voiceColor?this.voiceColor:"");e===null?(this.otoPreutter=0,this.otoOverlap=0,this._atAlias="R",this._atFilename=""):(this._oto=e,this.otoPreutter=e.pre,this.otoOverlap=e.overlap,this._atAlias=e.alias,this._atFilename=e.dirpath+(e.dirpath!==""?"/":"")+e.filename),this.autoFitParam()}autoFitParam(){const t=this.velocityRate;if(this.prev===void 0){this._atPreutter=this._preutter!==void 0?this._preutter*t:this.otoPreutter!==void 0?this.otoPreutter*t:void 0,this._atOverlap=this._overlap!==void 0?this._overlap*t:this.otoOverlap!==void 0?this.otoOverlap*t:void 0,this._atStp=this.stp!==void 0?this.stp:0;return}if(this.prev.length===void 0)throw new Error("prev length is not initial.");if(this.prev.tempo===void 0)throw new Error("prev tempo is not initial.");if(this.prev._lyric===void 0)throw new Error("prev lyric is not initial.");const e=this.prev.msLength*(this.prev._lyric==="R"?1:.5),s=(this._preutter!==void 0?this._preutter:this.otoPreutter)*t,i=(this._overlap!==void 0?this._overlap:this.otoOverlap)*t,o=this.stp!==void 0?this.stp:0;Number.isNaN(s)||Number.isNaN(i)||(e<s-i?(this._atPreutter=s/(s-i)*e,this._atOverlap=i/(s-i)*e,this._atStp=s-this._atPreutter+o):(this._atPreutter=s,this._atOverlap=i,this._atStp=o))}get outputMs(){return this.next===void 0||this.next.lyric==="R"?this.msLength+(this.atPreutter?this.atPreutter:0):this.msLength+(this.atPreutter?this.atPreutter:0)-(this.next.atPreutter?this.next.atPreutter:0)+(this.next.atOverlap?this.next.atOverlap:0)}get targetLength(){return(Math.round((this.outputMs+(this.atStp?this.atStp:0))/50)+1)*50}get pitchSpan(){return 60/this.tempo/480*5}getRenderPitch(){const t=(this.atPreutter?this.atPreutter:0)+(this.atStp?this.atStp:0),e=y(this.pitchSpan,0,this.targetLength/1e3),s=this.getBasePitch(e),i=this.prev!==void 0&&this.prev.lyric!=="R"?this.getInterpPitch(this.prev,e,t-this.prev.msLength):new Array(e.length).fill(0),o=this.prev!==void 0&&this.prev.lyric!=="R"?this.getVibratoPitches(this.prev,e,t-this.prev.msLength):new Array(e.length).fill(0),r=this.getInterpPitch(this,e,t),n=this.getVibratoPitches(this,e,t),p=this.next!==void 0&&this.next.lyric!=="R"?this.getInterpPitch(this.next,e,t+this.msLength):new Array(e.length).fill(0);return s.map((a,c)=>a+i[c]+o[c]+r[c]+n[c]+p[c])}getBasePitch(t){const e=new Array(t.length).fill(0),s=(this.atPreutter?this.atPreutter:0)+(this.atStp?this.atStp:0);let i=0,o=0;if(this.prev!==void 0&&this.prev.lyric!=="R"){const r=s-this.prev.msLength,n=this.prev.pbs?this.prev.pbs.time:0,p=this.pbs?this.pbs.time:0;if(n+r<0?i=0:i=t.findIndex(a=>a>=(n+r)/1e3),t[0]<=(p+s)/1e3?o=t.findIndex(a=>a>=(p+s)/1e3)-1:o=0,i<o)for(let a=i;a<o;a++)e[a]=(this.prev.notenum-this.notenum)*100}if(this.next!==void 0&&this.next.lyric!=="R"){const r=s+this.msLength,n=this.next.pbs?this.next.pbs.time:0;if(t.slice(-1)[0]>=(n+r)/1e3){i=t.findIndex(p=>p>=(n+r)/1e3);for(let p=i;p<e.length;p++)e[p]=(this.next.notenum-this.notenum)*100}}return e}getPitchInterpBase(t,e){const s=[t.pbs.time+e];t.pbw.forEach((r,n)=>{s.push(s[n]+r)});const i=t.pby.map(r=>r*10);t.prev!==void 0&&t.prev.lyric!=="R"?i.unshift((t.prev.notenum-t.notenum)*100):i.unshift(t.pbs.height*10);const o=t.pbm;for(;o.length<s.length-1;)o.push("");return{x:s,y:i,mode:o}}getInterpPitch(t,e,s){const i=new Array(e.length).fill(0);if(t.pbs===void 0||t.pby===void 0||t.pbw===void 0||t.pbm===void 0)return i;const{x:o,y:r,mode:n}=t.getPitchInterpBase(t,s);return o.forEach((p,a)=>{if(a===0||e.slice(-1)[0]<p/1e3)return;const c=e.findIndex(m=>m>=o[a-1]/1e3),d=e.findIndex(m=>m>=p/1e3),_=(p-o[a-1])/1e3,v=r[a]-r[a-1];if(!(d<=c))for(let m=c;m<=d;m++){const u=e[m]-o[a-1]/1e3;n[a-1]===""?i[m]=(Math.cos(Math.PI/_*u-Math.PI)+1)*v/2+r[a-1]:n[a-1]==="s"?i[m]=v/_*u+r[a-1]:n[a-1]==="r"?i[m]=Math.sin(Math.PI/_/2*u)*v+r[a-1]:n[a-1]==="j"&&(i[m]=(-Math.cos(Math.PI/_/2*u)+1)*v+r[a-1])}}),i}getVibratoPitches(t,e,s){const i=new Array(e.length).fill(0);if(t.vibrato===void 0)return i;const o=s+t.msLength*(100-t.vibrato.length)/100,r=s+t.msLength,n=e.findIndex(v=>v>=o/1e3),p=e[0]<r?e.findIndex(v=>v>=r/1e3):0;if(n>=p)return i;const a=p-n,c=Math.floor(a*t.vibrato.fadeInTime/100),d=Math.floor(a*t.vibrato.fadeOutTime/100),_=2*Math.PI*t.vibrato.phase/100;for(let v=n;v<p;v++){const m=this.getVibratoDepth(t.vibrato.depth,v,n,p,c,d),u=e[v]-o/1e3;i[v]=Math.round((Math.sin(2*Math.PI/(t.vibrato.cycle/1e3)*u+_)+t.vibrato.height/100)*m)}return i}getVibratoDepth(t,e,s,i,o,r){return e<=s+o&&o!==0?t*(e-s)/o:e>=i-r&&r!==0?t*(1-(e-i+r)/r):t}getRequestParam(t,e,s){this._oto===void 0?this.applyOto(t):this.autoFitParam();const i={resamp:void 0,append:void 0};return this._oto!==void 0&&!this.direct&&(i.resamp={inputWav:this._oto.dirpath+"/"+this._oto.filename,targetTone:x(this.notenum),velocity:this.velocity?this.velocity:s.velocity,flags:this.flags?this.flags:e,offsetMs:this._oto.offset,targetMs:this.targetLength,fixedMs:this._oto.velocity,cutoffMs:this._oto.blank,intensity:this._intensity?this._intensity:s.intensity,modulation:this._modulation?this._modulation:s.modulation,tempo:`!${this.tempo.toFixed(2)}`,pitches:I(this.getRenderPitch())}),this._oto!==void 0&&this.direct?i.append={inputWav:this._oto.dirpath+"/"+this._oto.filename,stp:this.atStp+this._oto.offset,length:this.outputMs,envelope:this.envelope?this.envelope:s.envelope,overlap:this.atOverlap}:this._oto!==void 0?i.append={stp:this.atStp,length:this.outputMs,envelope:this.envelope?this.envelope:s.envelope,overlap:this.atOverlap}:i.append={stp:0,length:this.outputMs,envelope:{point:[0,0],value:[]},overlap:0},i}deepCopy(){const t=new b;return t.index=this.index,t._length=this._length,t._lyric=this._lyric,t._notenum=this._notenum,t._tempo=this._tempo,t.hasTempo=this.hasTempo,t._preutter=this._preutter,t._overlap=this._overlap,t.otoPreutter=this.otoPreutter,t.otoOverlap=this.otoOverlap,t._stp=this._stp,t._atPreutter=this._atPreutter,t._atOverlap=this._atOverlap,t._atStp=this._atStp,t._atAlias=this._atAlias,t._atFilename=this._atFilename,t._velocity=this._velocity,t._intensity=this._intensity,t._modulation=this._modulation,t._pitches=this._pitches!==void 0?[...this._pitches]:void 0,t.pbStart=this.pbStart,t._pbs=this.pbs!==void 0?{...this._pbs}:void 0,t._pby=this.pby!==void 0?[...this._pby]:void 0,t._pbw=this.pbw!==void 0?[...this._pbw]:void 0,t._pbm=this.pbm!==void 0?[...this._pbm]:void 0,t._envelope=this.envelope!==void 0?{point:[...this._envelope.point],value:[...this._envelope.value]}:void 0,t._vibrato=this.vibrato!==void 0?{...this._vibrato}:void 0,t.label=this.label,t.direct=this.direct,t.region=this.region,t.regionEnd=this.regionEnd,t.flags=this.flags,t.voiceColor=this.voiceColor,t._oto=this._oto,t.prev=this.prev,t.next=this.next,t}}export{b as N};
