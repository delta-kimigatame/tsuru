var n=Object.defineProperty;var u=(c,o,e)=>o in c?n(c,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[o]=e;var r=(c,o,e)=>u(c,typeof o!="symbol"?o+"":o,e);import{d as p}from"./note-PQ4Q7K1Q.js";import{B as v}from"./BaseBatchProcess-DuMW4YHa.js";import{a}from"./Logging-BGLwk1OE.js";const d=["CV","VCV"],h=["*","param","none"],b=["vcvCrossFade","allCrossFade","reset"],y=/^([^ぁ-んァ-ヶ]*)([ぁ-んァ-ヶ]+)([^ ]*)$/,f=/[-aiuron] ([ぁ-んァ-ヶ]+)/,g=/[あかさたなはまやらわがざだばぱぁゃゎアカサタナハマヤラワガザダバパァャヮ]$/,V=/[いきしちにひみゐりぎじぢびぴぃイキシチニヒミヰリギジヂビピィ]$/,m=/[うくすつぬふむゆるぅぐずづぶぷウクスツヌフムユルゥグズヅブプヴ]$/,O=/[えけせてねへめゑれぇげぜでべぺエケセテネヘメヱレェゲゼデベペ]$/,K=/[おこそとのほもよろをごぞどぼぽぉオコソトノホモヨロヲゴゾドボポォ]$/,T=/ん$/,k=/^[あいうえおん]$/;class P extends v{constructor(){super(...arguments);r(this,"title","batchprocess.preprocessing.title");r(this,"summary","おまかせ下処理");r(this,"lyricProcess",(e,s)=>{s.replace&&(e.lyric=e.lyric.replace("を","お").replace("ぢ","じ").replace("づ","ず"));const i=y.exec(e.lyric);if(this.log(`lyric:${e.lyric},length:${e.lyric.length},${i}`,a.DEBUG),i){if(s.mode==="CV")s.useHeadingCV&&(e.prev===void 0||e.prev.lyric==="R")?e.lyric=`- ${i[2]}`:s.vowelConnect==="*"&&k.test(i[2])&&!(e.prev===void 0||e.prev.lyric==="R")?e.lyric=`* ${i[2]}`:(e.lyric=`${i[2]}`,s.vowelConnect==="param"&&(e.stp=50,e.preutter=25,e.overlap=50));else if(s.mode==="VCV"){const t=e.prev===void 0?"R":e.prev.lyric,l=y.exec(t);l?g.test(l[2])?e.lyric=`a ${i[2]}`:V.test(l[2])?e.lyric=`i ${i[2]}`:m.test(l[2])?e.lyric=`u ${i[2]}`:O.test(l[2])?e.lyric=`e ${i[2]}`:K.test(l[2])?e.lyric=`o ${i[2]}`:T.test(l[2])?e.lyric=`n ${i[2]}`:(this.log(`開発者の意図しない例外。lyric:${e.lyric}、prevLyric:${t}`,a.WARN),e.lyric=`- ${i[2]}`):e.lyric=`- ${i[2]}`}}});r(this,"envelopeProcess",(e,s)=>{s==="reset"?e.setEnvelope(void 0):s==="allCrossFade"?this.envelopeCrossfade(e):s==="vcvCrossFade"&&(f.test(e.lyric)?this.envelopeCrossfade(e):e.setEnvelope(void 0))});r(this,"envelopeCrossfade",e=>{const s=p.envelope.point[1],i=p.envelope.point[2],t=e.next===void 0||e.next.lyric==="R"||e.next.atOverlap===void 0||e.next.atOverlap<=0?i:e.next.atOverlap,l=e.prev===void 0||e.prev.lyric==="R"||e.atOverlap===void 0||e.atOverlap<=0?s:e.atOverlap;e.setEnvelope({point:[0,l,t],value:[0,100,100,0]})});r(this,"vibratoProcess",(e,s)=>{const i=e.next===void 0?"R":e.next.lyric;e.lyric==="R"?e.vibrato=void 0:i==="R"&&s.ending.isProcess&&e.length>=s.ending.threshold?e.vibrato="70,180,65,10,10,50,0,0":s.long.isProcess&&e.length>=s.long.threshold?e.vibrato="70,160,50,10,10,50,0,0":s.default.isProcess&&e.length>=s.default.threshold?e.vibrato="80,200,20,20,20,00,0,0":e.vibrato=void 0});r(this,"ui",[{titleKey:"batchprocess.preprocessing.lyric.title",items:[{key:"lyric",labelKey:"batchprocess.preprocessing.lyric.lyric",inputType:"switch",defaultValue:!0},{key:"lyricOptions.mode",labelKey:"batchprocess.preprocessing.lyric.mode",inputType:"select",options:d,displayOptionKey:"batchprocess.preprocessing.lyric.modeOptions",defaultValue:"VCV"},{key:"lyricOptions.replace",labelKey:"batchprocess.preprocessing.lyric.replace",inputType:"checkbox",defaultValue:!0},{key:"lyricOptions.useHeadingCV",labelKey:"batchprocess.preprocessing.lyric.useHeadingCV",inputType:"checkbox",defaultValue:!0},{key:"lyricOptions.vowelConnect",labelKey:"batchprocess.preprocessing.lyric.vowelConnect",inputType:"select",options:h,displayOptionKey:"batchprocess.preprocessing.lyric.vowelConnectOptions",defaultValue:"*"}]},{titleKey:"batchprocess.preprocessing.pitch.title",items:[{key:"pitch",labelKey:"batchprocess.preprocessing.pitch.pitch",inputType:"switch",defaultValue:!0},{key:"pitchOptions.speed",labelKey:"batchprocess.preprocessing.pitch.speed",inputType:"select",options:[60,80,100,130,160],displayOptionKey:"batchprocess.preprocessing.pitch.speedOptions",defaultValue:60},{key:"pitchOptions.timing",labelKey:"batchprocess.preprocessing.pitch.timing",inputType:"select",options:[-60,-45,-30,-15,0],displayOptionKey:"batchprocess.preprocessing.pitch.timingOptions",defaultValue:-45}]},{titleKey:"batchprocess.preprocessing.vibrato.title",items:[{key:"vibrato",labelKey:"batchprocess.preprocessing.vibrato.vibrato",inputType:"switch",defaultValue:!0},{key:"vibratoOptions.default.isProcess",labelKey:"batchprocess.preprocessing.vibrato.default",inputType:"checkbox",defaultValue:!1},{key:"vibratoOptions.default.threshold",labelKey:"batchprocess.preprocessing.vibrato.defaultThreshold",inputType:"select",options:[480,720,960,1440,1960],displayOptionKey:"batchprocess.preprocessing.vibrato.thresholdOptions",defaultValue:720},{key:"vibratoOptions.long.isProcess",labelKey:"batchprocess.preprocessing.vibrato.long",inputType:"checkbox",defaultValue:!0},{key:"vibratoOptions.long.threshold",labelKey:"batchprocess.preprocessing.vibrato.longThreshold",inputType:"select",options:[480,720,960,1440,1960],displayOptionKey:"batchprocess.preprocessing.vibrato.thresholdOptions",defaultValue:960},{key:"vibratoOptions.ending.isProcess",labelKey:"batchprocess.preprocessing.vibrato.ending",inputType:"checkbox",defaultValue:!0},{key:"vibratoOptions.ending.threshold",labelKey:"batchprocess.preprocessing.vibrato.endingThreshold",inputType:"select",options:[480,720,960,1440,1960],displayOptionKey:"batchprocess.preprocessing.vibrato.thresholdOptions",defaultValue:960}]},{titleKey:"batchprocess.preprocessing.envelope.title",items:[{key:"envelope",labelKey:"batchprocess.preprocessing.envelope.envelope",inputType:"switch",defaultValue:!0},{key:"envelopeType",labelKey:"batchprocess.preprocessing.envelope.type",inputType:"select",options:b,displayOptionKey:"batchprocess.preprocessing.envelope.option",defaultValue:"vcvCrossFade"}]},{titleKey:"batchprocess.preprocessing.velocity.title",items:[{key:"velocity",labelKey:"batchprocess.preprocessing.velocity.velocity",inputType:"switch",defaultValue:!1},{key:"velocityValue",labelKey:"batchprocess.preprocessing.velocity.value",inputType:"slider",min:0,max:200,step:1,defaultValue:100}]},{titleKey:"batchprocess.preprocessing.intensity.title",items:[{key:"intensity",labelKey:"batchprocess.preprocessing.intensity.intensity",inputType:"switch",defaultValue:!1},{key:"intensityValue",labelKey:"batchprocess.preprocessing.intensity.value",inputType:"slider",min:0,max:200,step:1,defaultValue:100}]},{titleKey:"batchprocess.preprocessing.modulation.title",items:[{key:"modulation",labelKey:"batchprocess.preprocessing.modulation.modulation",inputType:"switch",defaultValue:!0},{key:"modulationValue",labelKey:"batchprocess.preprocessing.modulation.value",inputType:"slider",min:-100,max:100,step:1,defaultValue:0}]},{titleKey:"batchprocess.preprocessing.flags.title",items:[{key:"flags",labelKey:"batchprocess.preprocessing.flags.flags",inputType:"switch",defaultValue:!1},{key:"flagsValue",labelKey:"batchprocess.preprocessing.flags.value",inputType:"textbox-string",defaultValue:""}]}]);r(this,"initialOptions",{lyric:!0,lyricOptions:{mode:"VCV",vowelConnect:"*",useHeadingCV:!0,replace:!0},pitch:!0,pitchOptions:{timing:-45,speed:60},vibrato:!0,vibratoOptions:{default:{isProcess:!1,threshold:720},long:{isProcess:!0,threshold:960},ending:{isProcess:!0,threshold:960}},envelope:!0,envelopeType:"vcvCrossFade",velocity:!1,velocityValue:100,intensity:!1,intensityValue:100,modulation:!0,modulationValue:0,flags:!1,flagsValue:""})}process(e,s){return super.process(e,s)}_process(e,s){const i=e.map(t=>t.deepCopy());return i.forEach(t=>{s.lyric&&s.lyricOptions!==void 0&&this.lyricProcess(t,s.lyricOptions),s.pitch&&s.pitchOptions!==void 0&&t.lyric!=="R"&&(t.pbsTime=s.pitchOptions.timing,t.pbsHeight=0,t.setPbw([s.pitchOptions.speed]),t.setPbm([""]),t.setPby([0])),s.vibrato&&s.vibratoOptions!==void 0&&this.vibratoProcess(t,s.vibratoOptions),s.envelope&&s.envelopeType!==void 0&&this.envelopeProcess(t,s.envelopeType),s.intensity&&s.intensityValue!==void 0&&t.lyric!=="R"&&(t.intensity=s.intensityValue),s.velocity&&s.velocityValue!==void 0&&t.lyric!=="R"&&(t.velocity=s.velocityValue),s.modulation&&s.modulationValue!==void 0&&t.lyric!=="R"&&(t.modulation=s.modulationValue),s.flags&&s.flagsValue!==void 0&&t.lyric!=="R"&&(t.flags=s.flagsValue)}),i}}export{P as PreprocessingBatchProcess};
