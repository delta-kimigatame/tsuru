var w=Object.defineProperty;var k=(h,t,s)=>t in h?w(h,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):h[t]=s;var i=(h,t,s)=>k(h,typeof t!="symbol"?t+"":t,s);import{r as u,R as d}from"./resampWorker-CEysAfiK.js";import{L as n}from"./Logging-BGLwk1OE.js";import{U as m,T as g}from"./VoiceBank-C9vet1UG.js";import{u as $}from"./cookieStore-BsTWuq-c.js";import{u as R}from"./musicProjectStore-BsvuTYmn.js";class S{constructor(){i(this,"cache");i(this,"wp");i(this,"checkKey",(t,s)=>t in this.cache?this.cache[t].key===s:!1);i(this,"set",(t,s,e)=>{this.checkKey(t,s)||(this.cache[t]={key:s,data:Int16Array.from(this.wp.InverseLogicalNormalize(Array.from(e),16))})});i(this,"get",(t,s)=>{if(this.checkKey(t,s))return Float64Array.from(this.wp.LogicalNormalize(Array.from(this.cache[t].data),16))});i(this,"createKey",t=>`${t.inputWav}|${t.targetTone}|${t.velocity}|${t.flags}|${t.offsetMs}|${t.targetMs}|${t.fixedMs}|${t.cutoffMs}|${t.intensity}|${t.modulation}|${t.tempo}|${t.pitches}`);i(this,"checkNote",(t,s,e,r)=>{const a=t.getRequestParam(s,e,r).resamp;return a===void 0?!1:this.checkKey(t.index,this.createKey(a))});i(this,"clear",()=>{this.cache={}});this.cache={},this.wp=new m}}const f=new S,v=5;class y{constructor(){i(this,"_data");this._data=new Array}get data(){return this._data}append(t){const s=u.frameRate*t.stp/1e3,e=u.frameRate*t.length/1e3,r=u.frameRate*t.overlap/1e3,a=t.inputData.slice(s,s+e),o=this.getEnvelope(t.length,t.envelope),l=this.applyEnvelope(a,o);this.concat(r,l)}getEnvelope(t,s){const e=new Array;s.point[0]!==0&&e.push(0),e.push(s.point[0]),e.push(s.point[0]+s.point[1]),s.point.length===5&&e.push(s.point[0]+s.point[1]+s.point[4]),s.point.length>=4?(e.push(t-s.point[2]-s.point[3]),e.push(t-s.point[3]),s.point[3]!==0&&e.push(t)):s.point.length===3&&(e.push(t-s.point[2]),e.push(t));const r=e.map(o=>Math.floor(u.frameRate*o/1e3)),a=[];for(s.value.length>=3&&(s.point[0]!==0&&a.push(0),a.push(s.value[0]),a.push(s.value[1]),s.value.length===5&&a.push(s.value[4]),a.push(s.value[2]),s.value.length>=4&&a.push(s.value[3]));a.length<r.length;)a.push(0);return{framePoint:r,value:a}}applyEnvelope(t,s){const e=new Array;if(s.framePoint.length===2)return new Array(t.length).fill(0);let r=1;return t.forEach((a,o)=>{for(;o===s.framePoint[r];)r++;const l=s.value[r]-s.value[r-1],c=s.framePoint[r]-s.framePoint[r-1],p=(o-s.framePoint[r])*l/c+s.value[r];e.push(a*p/100)}),e}concat(t,s){const e=t>s.length?s.length:t;if(e>this._data.length){const a=new Array(e-this._data.length).fill(0);this._data=a.concat(this._data)}const r=e===0?[]:this._data.slice(-1*e).map((a,o)=>a+s[o]);this._data=e===0?this._data.concat(s.slice(e)):this._data.slice(0,-1*e).concat(r,s.slice(e))}output(){const t=new m;return g(u.frameRate,u.depth,t.InverseLogicalNormalize(this._data,u.depth)).Output()}}const P=h=>{let t=()=>{},s=()=>{};return{promise:new Promise((r,a)=>{t=r,s=a}),resolve:t,reject:s,index:h}};class W{constructor(t){i(this,"workers");i(this,"taskQueue");this.workers=[],this.taskQueue=[];for(let s=0;s<t;s++)this.workers.push({worker:new d,busy:!1})}runResamp(t,s,e){const r=P(e),a={request:t,vb:s,deferred:r};return this.enqueueTask(a),r.promise}enqueueTask(t){this.taskQueue.push(t),this.assignTasks()}assignTasks(){for(const t of this.workers)if(!t.busy&&this.taskQueue.length>0){const s=this.taskQueue.shift();s&&(t.busy=!0,t.worker.processResamp(s.request,s.vb).then(e=>{s.deferred.resolve(e)}).catch(e=>{s.deferred.reject(e)}).finally(()=>{t.busy=!1,this.assignTasks()}))}}clearTasks(){this.taskQueue.forEach(t=>{t.deferred.reject(new Error("Canceled"))}),this.taskQueue=[]}clearTask(t){this.taskQueue=this.taskQueue.filter(s=>s.deferred.index===t?(s.deferred.reject(new Error("Canceled")),!1):!0)}}class Q{constructor(){i(this,"workersPool");i(this,"resampResults");i(this,"wavtool");i(this,"resamp",async(t,s,e)=>{if(t.resamp===void 0){const r=Math.ceil(t.append.length/1e3*u.frameRate);return n.debug(`休符。長さ:${r}`,"synthesis,SynthesisWorker"),new Float64Array(r)}else{const r=f.createKey(t.resamp);return f.checkKey(e,r)?(n.debug(`キャッシュヒット。index:${e},request:${JSON.stringify(t.resamp)}`,"synthesis,SynthesisWorker"),f.get(e,r)):(n.debug(`workerpoolにセット。request:${JSON.stringify(t.resamp)}`,"synthesis,SynthesisWorker"),this.workersPool.runResamp(t.resamp,s,e).then(o=>(f.set(e,r,o),o)).catch(o=>{if(o.message!=="Canceled")throw o;return new Float64Array(0)}))}});i(this,"append",async(t,s=0,e)=>{if(s>=this.resampResults.length)return;let r;try{r=await this.resampResults[s]}catch(a){const o=`resampResultsでエラー発生(index:${s}): ${a}`;throw n.error(o,"synthesis,SynthesisWorker"),new Error(o)}try{n.debug(`wavtoolで結合。${s}`,"synthesis,SynthesisWorker"),e(s),this.wavtool.append({inputData:Array.from(r),...t[s].append}),await this.append(t,s+1,e)}catch(a){const o=`append処理でエラー発生(index:${s}): ${a}`;throw n.error(o,"synthesis,SynthesisWorker"),new Error(o)}});i(this,"clearTask",t=>{this.workersPool.clearTask(t)});n.debug("workerspoolの初期化","synthesis,SynthesisWorker"),this.workersPool=new W(v),n.debug("wavtoolの初期化","synthesis,SynthesisWorker"),this.wavtool=new y}async synthesis(t,s=e=>{}){this.wavtool=new y,this.workersPool.clearTasks();const{vb:e,ust:r}=R.getState(),{defaultNote:a}=$.getState(),o=r.getRequestParam(e,a,t),l=t.length!==0?t:r.notes.map(c=>c.index);n.info("音声合成開始","synthesis,SynthesisWorker"),this.resampResults=o.map((c,p)=>this.resamp(c,e,l[p])),await this.append(o,0,s),n.info("音声合成終了","synthesis,SynthesisWorker");try{return n.info("wavに変換","synthesis,SynthesisWorker"),this.wavtool.output()}catch(c){throw n.error("wav変換に失敗しました","synthesis,SynthesisWorker"),c}}}export{Q as S,v as a,f as r};
