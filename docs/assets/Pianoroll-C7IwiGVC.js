import{j as t}from"./jsx-runtime-D_zvdyIk.js";import{R as d}from"./index-iNOV5qWA.js";import{u as R,a as k,E as L}from"./useVerticalFooterMenu-C4WwAev3.js";import{P as e,C as p,a as v}from"./PianorollBackground-CeWu-PaL.js";import{L as x}from"./Logging-BGLwk1OE.js";import{u as y}from"./cookieStore-BsTWuq-c.js";import{u as M}from"./musicProjectStore-BsvuTYmn.js";import{P as S}from"./PianorollNotes-DacBM-LF.js";import{n as W,m as w,P as G}from"./PianorollPitch-Ss1AkXxq.js";import{u as A}from"./useThemeMode-DBwfopSL.js";import{n as D}from"./Notenum-DIq-GRnt.js";import{P as K}from"./PianorollVibrato-B6P6yanw.js";import{B as I}from"./Box-D69FHGj3.js";const N=n=>{const{colorTheme:r,verticalZoom:l,horizontalZoom:s}=y(),i=A();return t.jsx("svg",{width:n.totalLength*e.NOTES_WIDTH_RATE*s,height:e.TOTAL_HEIGHT*l,style:{pointerEvents:"none",display:"block",position:"absolute",top:0,left:0,zIndex:4},"data-testid":"pianoroll-seekbar",children:t.jsx("line",{x1:n.seekBarX,x2:n.seekBarX,y1:0,y2:e.TOTAL_HEIGHT*l,stroke:p[r][i].seekBar,strokeWidth:e.SEEKBAR_WIDTH})})};N.__docgenInfo={description:"",methods:[],displayName:"PianorollSeekbar",props:{seekBarX:{required:!0,tsType:{name:"number"},description:""},totalLength:{required:!0,tsType:{name:"number"},description:""}}};const P=()=>{const{colorTheme:n,verticalZoom:r,horizontalZoom:l}=y(),s=A();return t.jsxs("svg",{width:e.TONEMAP_WIDTH,height:e.TOTAL_HEIGHT*r,style:{pointerEvents:"none",display:"block",position:"absolute",top:0,left:0,zIndex:1},children:[[...new Array(e.KEY_COUNT)].map((i,o)=>t.jsxs(d.Fragment,{children:[t.jsx("rect",{x:0,y:o*e.KEY_HEIGHT*r,width:"100%",height:e.KEY_HEIGHT*r,fill:e.BLACK_KEY_REMAINDERS.includes(o%12)?p[n][s].tonemapBlackKey:p[n][s].tonemapWhiteKey}),t.jsx("text",{x:e.LYRIC_PADDING_LEFT,y:o*e.KEY_HEIGHT*r+e.KEY_HEIGHT*r/2,fontFamily:'"Noto Sans JP", "Roboto", "Helvetica", "Arial", sans-serif',fill:p[n][s].lyric,fontSize:e.LYRIC_FONT_SIZE,pointerEvents:"none",dominantBaseline:"middle",style:{userSelect:"none",pointerEvents:"none"},children:D(107-o)}),t.jsx("line",{x1:0,x2:e.TONEMAP_WIDTH,y1:o*e.KEY_HEIGHT*r,y2:o*e.KEY_HEIGHT*r,stroke:p[n][s].horizontalSeparator,strokeWidth:o%12===0?e.HORIZONTAL_SEPARATOR_WIDTH_OCTAVE:e.HORIZONTAL_SEPARATOR_WIDTH})]},o)),t.jsx("line",{x1:0,x2:e.TONEMAP_WIDTH,y1:e.KEY_COUNT*e.KEY_HEIGHT*r,y2:e.KEY_COUNT*e.KEY_HEIGHT*r,stroke:p[n][s].horizontalSeparator,strokeWidth:e.HORIZONTAL_SEPARATOR_WIDTH_OCTAVE})]})};P.__docgenInfo={description:"ピアノロールの左側の音高名を表示する部分",methods:[],displayName:"PianorollTonemap"};const C=n=>{const{verticalZoom:r,horizontalZoom:l}=y(),{notes:s,vb:i}=M(),o=d.useRef(null),_=W(60,r),H=d.useMemo(()=>{if(x.debug("vbの更新検知","Pianoroll"),i!==null)return i.portrait===void 0?void 0:URL.createObjectURL(new Blob([i.portrait],{type:"image/png"}))},[i]),O=R();k();const[b,j]=d.useState(0),{notesLeft:u,notesLeftMs:T,totalLength:h}=d.useMemo(()=>{if(x.debug("notesの更新検知","Pianoroll"),s.length===0)return{notesLeft:[],notesLeftMs:[],totalLength:0};x.debug("notesLeft,notesLeftMs,totalLengthの再計算","Pianoroll");const m=new Array;let E=0;const a=new Array;let g=0;for(let c=0;c<s.length;c++)a.push(g),g+=s[c].length,m.push(E),E+=s[c].msLength;return{notesLeft:a,notesLeftMs:m,totalLength:g}},[s]);return d.useEffect(()=>{x.debug(`コンポーネントマウント、c4Center:${_}`,"Pianoroll"),window.scrollTo(0,_-window.innerHeight/2)},[_]),d.useEffect(()=>{if(T.length!==s.length||T.length!==u.length||s.length===0)return;const m=n.selectedNotesIndex.length===0?0:n.selectedNotesIndex[0],E=T[m];let a=m;for(let f=a;f<T.length-1;f++)if(T[m+f+1]-E>n.playingMs){a=f;break}const c=u[a]*e.NOTES_WIDTH_RATE*l+w(n.playingMs-T[a],s[a].tempo,l);c<o.current.clientWidth/2?o.current.scrollTo(0,o.current.scrollTop):o.current.scrollTo(Math.min(c-o.current.clientWidth/2,o.current.scrollWidth-o.current.clientWidth/2),o.current.scrollTop),j(c)},[l,n.playingMs]),t.jsxs(I,{sx:{display:"flex",width:"100%",height:e.TOTAL_HEIGHT*r+40,overflowX:"hidden",overflowY:"auto",m:0,p:0},children:[t.jsx(I,{sx:{display:"block",width:e.TONEMAP_WIDTH},children:t.jsx("svg",{width:e.TONEMAP_WIDTH,height:e.TOTAL_HEIGHT*r,style:{display:"block",position:"relative"},children:t.jsx(P,{})})}),t.jsx(I,{sx:{display:"block",overflowX:"scroll",position:"relative"},ref:o,children:t.jsxs("svg",{width:(h+480*8)*e.NOTES_WIDTH_RATE*l,height:e.TOTAL_HEIGHT*r,style:{display:"block",position:"relative"},children:[t.jsx("g",{id:"background",children:t.jsx(v,{totalLength:h})}),t.jsx("g",{id:"notes",children:t.jsx(S,{selectedNotesIndex:[],totalLength:h,notesLeft:u})}),t.jsx("g",{id:"pitch",children:t.jsx(G,{selectedNotesIndex:[],totalLength:h,notesLeft:u})}),t.jsx("g",{id:"vibrato",children:t.jsx(K,{selectedNotesIndex:[],totalLength:h,notesLeft:u})}),t.jsx("g",{id:"seekbar",children:n.playing&&t.jsx(N,{seekBarX:b,totalLength:h})})]})}),H!==void 0&&t.jsx("img",{src:H,style:{maxHeight:`min(50%,${i.portraitHeight}px)`,objectFit:"contain",position:"fixed",bottom:O?0:L.FOOTER_MENU_SIZE,right:O?L.FOOTER_MENU_SIZE:0,zIndex:10,maxWidth:"50%",pointerEvents:"none",userSelect:"none",opacity:i.portraitOpacity}})]})};C.__docgenInfo={description:"",methods:[],displayName:"Pianoroll",props:{playing:{required:!0,tsType:{name:"boolean"},description:"再生状況"},playingMs:{required:!0,tsType:{name:"number"},description:"再生中の時間"},selectedNotesIndex:{required:!0,tsType:{name:"Array",elements:[{name:"number"}],raw:"Array<number>"},description:"選択中のノートのインデックス"}}};export{C as P};
